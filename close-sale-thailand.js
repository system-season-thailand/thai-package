const closeSellSupabaseUrl="https://lpyfcvjljejmxgoynbxb.supabase.co",closeSellSupabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxweWZjdmpsamVqbXhnb3luYnhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4ODk4OTYsImV4cCI6MjA2MjQ2NTg5Nn0.Ml7ICH8BoBZFbdRW-hOaN3OFX5j386QR_z0C4KmTt5k",closeSellSupabase="undefined"!=typeof window&&window.__supabaseCreateClient?window.__supabaseCreateClient(closeSellSupabaseUrl,closeSellSupabaseKey):null,monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],arabicMonths={"يناير":0,"فبراير":1,"مارس":2,"أبريل":3,"مايو":4,"يونيو":5,"يوليو":6,"أغسطس":7,"سبتمبر":8,"أكتوبر":9,"نوفمبر":10,"ديسمبر":11},closeSellHotelDataCache=new Map;let hasFetchedCloseSellData=!1;const normalizeName=e=>(e||"").toString().trim().replace(/\s+/g," ").normalize("NFKC").toLowerCase(),utcMidnight=e=>Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),msPerDay=864e5;function safeGetValue(e){return(document.getElementById(e)?.value||"").trim()}function formatDateRanges(e){if(!Array.isArray(e)||0===e.length)return"";const t=e.map(e=>new Date(e)).sort((e,t)=>e-t),l=[];let a=t[0],o=t[0];for(let e=1;e<t.length;e++){const n=t[e],s=t[e-1];utcMidnight(n)-utcMidnight(s)===864e5||(l.push([a,o]),a=n),o=n}return l.push([a,o]),l.map(([e,t])=>{const l=e.getDate(),a=e.getMonth(),o=e.getFullYear(),n=t.getDate(),s=t.getMonth(),r=t.getFullYear(),i=monthNames[a].slice(0,3),c=monthNames[s].slice(0,3);return o===r?a===s?l===n?`${l} ${i} ${o}`:`${l}-${n} ${i} ${o}`:`${l} ${i} - ${n} ${c} ${o}`:`${l} ${i} ${o} - ${n} ${c} ${r}`}).join(", ")}function parseArabicDateUniversal(e,t=null){if(!e||"string"!=typeof e)return null;const l=e.trim().split(/\s+/);if(l.length<2)return null;const a=parseInt(l[0],10);if(!Number.isInteger(a))return null;const o=l[1],n=arabicMonths[o];if(void 0===n)return null;let s;if(l.length>=3){if(s=parseInt(l[2],10),!Number.isInteger(s))return null}else t instanceof Date?(s=t.getFullYear(),n<t.getMonth()&&(s+=1)):s=(new Date).getFullYear();const r=new Date(s,n,a);return isNaN(r.getTime())?null:r}function parseArabicDayMonth(e){if(!e||"string"!=typeof e)return null;const t=e.trim().split(/\s+/);if(t.length<2)return null;const l=parseInt(t[0],10),a=t[1],o=arabicMonths[a];return Number.isInteger(l)&&void 0!==o?{day:l,monthIndex:o}:null}function parseHotelAvailabilityToPairs(e,t){const l=[];if(!e||"string"!=typeof e)return l;const a=monthNames.indexOf(t);if(-1===a)return l;const o=e.split(",");for(let e of o)if(e=e.trim(),e)if(e.includes("-")){const[t,o]=e.split("-").map(e=>e.trim()),n=parseInt(t,10),s=parseInt(o,10);if(!Number.isInteger(n)||!Number.isInteger(s)||n>s)continue;for(let e=n;e<=s;e++)l.push({monthIndex:a,day:e})}else{const t=parseInt(e,10);if(!Number.isInteger(t))continue;l.push({monthIndex:a,day:t})}return l}async function ensureCloseSellCache(){if(!hasFetchedCloseSellData)if(closeSellSupabase)try{const{data:e,error:t}=await closeSellSupabase.rpc("get_all_public_tables_data");if(t)return void console.error("Supabase RPC error:",t);for(const[t,l]of Object.entries(e||{})){if(!Array.isArray(l))continue;const e=[];l.forEach(t=>{const l=t["Room Type"]||t.roomType||"Room",a=[];monthNames.forEach(e=>{const l=t[e];l&&"string"==typeof l&&""!==l.trim()&&a.push(...parseHotelAvailabilityToPairs(l,e))}),e.push({roomType:l,availabilityPairs:a})}),closeSellHotelDataCache.set(normalizeName(t),e)}hasFetchedCloseSellData=!0}catch(e){console.error("RPC fetch failed:",e)}else console.error("Close-sell Supabase client not available (ensure Supabase script loads before this file).")}function mapPairToDate(e,t){const l=t.getFullYear(),a=t.getMonth(),o=e.monthIndex<a?l+1:l;return new Date(o,e.monthIndex,e.day)}async function fetchAllCloseSellDataFunction_Supabase(){await ensureCloseSellCache();const e=document.querySelectorAll(".all_hotels_names_div_class h3");e.forEach(e=>{e.style.opacity="0",e.style.pointerEvents="none",e.style.backgroundColor="white",e.style.color="black",e._closeSellHandler&&(e.removeEventListener("click",e._closeSellHandler),delete e._closeSellHandler)});const t=safeGetValue("hotel_check_in_input_id"),l=safeGetValue("hotel_check_out_input_id");if(!t||!l)return void e.forEach(e=>{e.style.opacity="1",e.style.pointerEvents="auto"});const a=parseArabicDayMonth(t),o=parseArabicDayMonth(l);if(!a||!o)return console.warn("Invalid check-in/out format - expected 'DD MONTH' or 'DD MONTH YYYY'."),void e.forEach(e=>{e.style.opacity="1",e.style.pointerEvents="auto"});const n=(new Date).getFullYear(),s=new Date(n,a.monthIndex,a.day);let r=n;o.monthIndex<a.monthIndex&&(r=n+1);const i=new Date(r,o.monthIndex,o.day);e.forEach(e=>{const t=e.innerText?.trim().split(" - ")[0]||"",l=normalizeName(t),a=closeSellHotelDataCache.get(l)||[],o=[];if(a.forEach(({roomType:e,availabilityPairs:t})=>{const l=t.map(e=>mapPairToDate(e,s)).filter(e=>e>=s&&e<=i).sort((e,t)=>e-t);l.length>0&&o.push({roomType:e,dates:l,pairs:t})}),o.length>0){e.style.backgroundColor="rgb(180,0,0)",e.style.color="white",e.style.opacity="1";const t=()=>{const e=safeGetValue("whole_package_start_date_input_id"),t=safeGetValue("whole_package_end_date_input_id");if(!e||!t)return void showCloseSellModal("Please select package start and end dates.");const l=parseArabicDateUniversal(e),a=parseArabicDateUniversal(t,l);if(!l||!a)return void showCloseSellModal("Invalid package start/end format.");const n=document.getElementById("all_close_sell_room_type_found_p_id");n&&(n.innerText=o.map((e,t)=>`${t+1}- ${e.roomType}`).join("\n"));const s=[];o.forEach(({roomType:e,pairs:t})=>{const o=t.map(e=>mapPairToDate(e,l)).sort((e,t)=>e-t).filter(e=>e>=l&&e<=a);if(o.length>0){const t=formatDateRanges(o);s.push(`${e}: ${t}`)}});showCloseSellModal(s.length?s.join("\n"):"No room availability inside selected package range.")};e._closeSellHandler=t,e.addEventListener("click",t)}else e.style.backgroundColor="white",e.style.color="black",e.style.opacity="0.6"}),e.forEach(e=>{e.style.pointerEvents="auto",e.style.opacity="1"})}function showCloseSellModal(e){const t=document.getElementById("closeSellModal"),l=document.getElementById("closeSellMessage");l&&(l.innerHTML=(e||"").replace(/\n/g,"<br>"));let a=document.getElementById("closeSellOverlay");a||(a=document.createElement("div"),a.id="closeSellOverlay",a.className="black_overlay",a.style.position="fixed",a.style.inset="0",a.style.backgroundColor="rgba(0,0,0,0.6)",a.style.zIndex="9998",a.style.transition="opacity 200ms ease",a.style.opacity="0",document.body.appendChild(a),a.addEventListener("click",closeCloseSellModal)),a.style.opacity="1",t&&(t.style.display="flex",t.classList.add("show"),t.classList.remove("hide"),t.style.zIndex="9999")}function closeCloseSellModal(){const e=document.getElementById("closeSellModal"),t=document.getElementById("closeSellOverlay");t&&(t.style.opacity="0",setTimeout(()=>t.remove(),250)),e&&(e.classList.remove("show"),e.classList.add("hide"),setTimeout(()=>{e.style.display="none"},200))}async function refreshCloseSellCache(e=!1){e&&(closeSellHotelDataCache.clear(),hasFetchedCloseSellData=!1),await fetchAllCloseSellDataFunction_Supabase()}
