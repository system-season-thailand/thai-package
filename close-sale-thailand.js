const supabaseUrl="https://lpyfcvjljejmxgoynbxb.supabase.co",supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxweWZjdmpsamVqbXhnb3luYnhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4ODk4OTYsImV4cCI6MjA2MjQ2NTg5Nn0.Ml7ICH8BoBZFbdRW-hOaN3OFX5j386QR_z0C4KmTt5k",supabase=window.supabase.createClient(supabaseUrl,supabaseKey),closeSellHotelDataCache=new Map;let hasFetchedCloseSellData=!1;const fetchAllCloseSellDataFunction_Supabase=async()=>{const e=document.querySelectorAll(".all_hotels_names_div_class h3");if(e.forEach((e=>{e.style.opacity="0",e.style.pointerEvents="none",e.style.backgroundColor="white",e.style.color="black",e.removeEventListener("click",e.clickHandler)})),!hasFetchedCloseSellData){const{data:e,error:t}=await supabase.rpc("get_all_public_tables_data");if(t)return void console.error("Error getting all tables data:",t);for(const[t,a]of Object.entries(e)){if(!Array.isArray(a))continue;const e=[];a.forEach((a=>{const o=a["Room Type"]||a.roomType||"Room",l=[];["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((e=>{const t=a[e];if(t&&"string"==typeof t){const a=parseHotelAvailability(t,e);a.map((e=>e.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}).replace(/,/g,"")));l.push(...a)}})),e.push({hotelName:t,roomType:o,availability:l})})),closeSellHotelDataCache.set(t.toLowerCase(),e)}hasFetchedCloseSellData=!0}const t=document.getElementById("hotel_check_in_input_id").value,a=document.getElementById("hotel_check_out_input_id").value;if(t&&a){const o=parseArabicDateForCloseSellData(t),l=parseArabicDateForCloseSellData(a);e.forEach((e=>{const t=e.innerText.trim().split(" - ")[0].toLowerCase(),a=closeSellHotelDataCache.get(t);let s=[];a&&a.forEach((({roomType:e,availability:t})=>{const a=t.filter((e=>e>=o&&e<=l));if(a.length>0){s.some((t=>t.roomType===e))||s.push({roomType:e,dates:a})}}));if(s.length>0){e.style.backgroundColor="rgb(180, 0, 0)",e.style.color="white",e.style.opacity="1";const t=()=>{const e=document.getElementById("whole_package_start_date_input_id").value,t=document.getElementById("whole_package_end_date_input_id").value,o=parseArabicDateForCloseSellData(e),l=parseArabicDateForCloseSellData(t),s=new Map;a?.forEach((({roomType:e,availability:t})=>{s.has(e)||s.set(e,[]),s.get(e).push(...t)}));const r=[];s.forEach(((e,t)=>{const a=[...new Set(e.map((e=>e.getTime())))].map((e=>new Date(e))).sort(((e,t)=>e-t)).filter((e=>e>=o&&e<=l));if(a.length>0){const e=formatDateRanges(a);r.push(`${t}: ${e}`)}}));const n=r.join("\n");showCloseSellModal(n)};e.clickHandler=t,e.addEventListener("click",t)}}))}e.forEach((e=>{e.style.opacity="1",e.style.pointerEvents="auto"}))},formatDateRanges=e=>{if(!e.length)return"";e.sort(((e,t)=>e-t));const t=[];let a=e[0],o=e[0];for(let l=1;l<e.length;l++){const s=e[l];s-e[l-1]===864e5||(t.push([a,o]),a=s),o=s}return t.push([a,o]),t.map((([e,t])=>{const a=e.getDate(),o=e.toLocaleString("en-US",{month:"short"}),l=t.getDate(),s=t.toLocaleString("en-US",{month:"short"});return o===s?a===l?`${a} ${o}`:`${a}-${l} ${o}`:`${a} ${o} - ${l} ${s}`})).join(", ")},parseHotelAvailability=(e,t,a=(new Date).getFullYear())=>{const o=[],l=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(t);if(-1===l)return console.warn(`⚠️ Unknown month name: ${t}`),o;const s=e.split(",");for(let e of s)if(e=e.trim(),e.includes("-")){const[t,s]=e.split("-").map((e=>parseInt(e.trim(),10))),r=Number(t),n=Number(s);if(!isNaN(r)&&!isNaN(n)&&r<=n)for(let e=r;e<=n;e++){const t=new Date(a,l,e);o.push(t)}}else{const t=parseInt(e,10);if(!isNaN(t)){const e=new Date(a,l,t);o.push(e)}}return o},parseEnglishDates=e=>{const[t,a]=e.split(" ");if(t.includes("-")){const[e,o]=t.split("-").map(Number),l=parseMonth(a);return Array.from({length:o-e+1},((t,a)=>new Date((new Date).getFullYear(),l,e+a)))}return[new Date((new Date).getFullYear(),parseMonth(a),parseInt(t))]},parseArabicDateForCloseSellData=e=>{const[t,a]=e.split(" ");return new Date((new Date).getFullYear(),{"يناير":0,"فبراير":1,"مارس":2,"أبريل":3,"مايو":4,"يونيو":5,"يوليو":6,"أغسطس":7,"سبتمبر":8,"أكتوبر":9,"نوفمبر":10,"ديسمبر":11}[a],parseInt(t))},parseMonth=e=>({Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}[e]);
